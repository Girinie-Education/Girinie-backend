from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
from django.db.models import Count
from datetime import datetime
from random import randint
from drf_yasg.utils import swagger_auto_schema
from drf_yasg import openapi

from child_users.models import ChildUser
from reward_calendar.models import RewardCalendar

KOREAN_LEARNING_QUOTES = [
    "공부은 삶을 바꾼다.",
    "공부은 미래를 바꾼다.",
    "공부은 희망이 된다.",
    "공부은 노력에서 시작된다.",
    "공부은 인내를 만든다.",
    "공부은 습관에서 비롯된다.",
    "공부은 매일 반복해야 한다.",
    "공부은 두려움을 이긴다.",
    "공부은 삶의 무기다.",
    "공부은 성공의 열쇠다.",
    "공부은 실력을 만든다.",
    "공부은 성장을 이끈다.",
    "공부은 나를 단단하게 만든다.",
    "공부은 더 나은 내일을 만든다.",
    "공부은 절대 배신하지 않는다.",
    "공부은 모든 것의 시작이다.",
    "공부은 실패를 극복하게 한다.",
    "공부은 끊임없이 반복된다.",
    "공부은 매일 쌓아야 한다.",
    "공부은 행동으로 증명된다.",
    "공부은 나를 믿는 것이다.",
    "공부은 스스로를 키운다.",
    "공부은 나를 바꾼다.",
    "공부은 오늘부터 가능하다.",
    "공부은 지금 시작된다.",
    "배움은 삶을 바꾼다.",
    "배움은 미래를 바꾼다.",
    "배움은 희망이 된다.",
    "배움은 노력에서 시작된다.",
    "배움은 인내를 만든다.",
    "배움은 습관에서 비롯된다.",
    "배움은 매일 반복해야 한다.",
    "배움은 두려움을 이긴다.",
    "배움은 삶의 무기다.",
    "배움은 성공의 열쇠다.",
    "배움은 실력을 만든다.",
    "배움은 성장을 이끈다.",
    "배움은 나를 단단하게 만든다.",
    "배움은 더 나은 내일을 만든다.",
    "배움은 절대 배신하지 않는다.",
    "배움은 모든 것의 시작이다.",
    "배움은 실패를 극복하게 한다.",
    "배움은 끊임없이 반복된다.",
    "배움은 매일 쌓아야 한다.",
    "배움은 행동으로 증명된다.",
    "배움은 나를 믿는 것이다.",
    "배움은 스스로를 키운다.",
    "배움은 나를 바꾼다.",
    "배움은 오늘부터 가능하다.",
    "배움은 지금 시작된다.",
    "성장은 삶을 바꾼다.",
    "성장은 미래를 바꾼다.",
    "성장은 희망이 된다.",
    "성장은 노력에서 시작된다.",
    "성장은 인내를 만든다.",
    "성장은 습관에서 비롯된다.",
    "성장은 매일 반복해야 한다.",
    "성장은 두려움을 이긴다.",
    "성장은 삶의 무기다.",
    "성장은 성공의 열쇠다.",
    "성장은 실력을 만든다.",
    "성장은 성장을 이끈다.",
    "성장은 나를 단단하게 만든다.",
    "성장은 더 나은 내일을 만든다.",
    "성장은 절대 배신하지 않는다.",
    "성장은 모든 것의 시작이다.",
    "성장은 실패를 극복하게 한다.",
    "성장은 끊임없이 반복된다.",
    "성장은 매일 쌓아야 한다.",
    "성장은 행동으로 증명된다.",
    "성장은 나를 믿는 것이다.",
    "성장은 스스로를 키운다.",
    "성장은 나를 바꾼다.",
    "성장은 오늘부터 가능하다.",
    "성장은 지금 시작된다.",
    "노력은 삶을 바꾼다.",
    "노력은 미래를 바꾼다.",
    "노력은 희망이 된다.",
    "노력은 노력에서 시작된다.",
    "노력은 인내를 만든다.",
    "노력은 습관에서 비롯된다.",
    "노력은 매일 반복해야 한다.",
    "노력은 두려움을 이긴다.",
    "노력은 삶의 무기다.",
    "노력은 성공의 열쇠다.",
    "노력은 실력을 만든다.",
    "노력은 성장을 이끈다.",
    "노력은 나를 단단하게 만든다.",
    "노력은 더 나은 내일을 만든다.",
    "노력은 절대 배신하지 않는다.",
    "노력은 모든 것의 시작이다.",
    "노력은 실패를 극복하게 한다.",
    "노력은 끊임없이 반복된다.",
    "노력은 매일 쌓아야 한다.",
    "노력은 행동으로 증명된다.",
    "노력은 나를 믿는 것이다.",
    "노력은 스스로를 키운다.",
    "노력은 나를 바꾼다.",
    "노력은 오늘부터 가능하다.",
    "노력은 지금 시작된다.",
    "습관은 삶을 바꾼다.",
    "습관은 미래를 바꾼다.",
    "습관은 희망이 된다.",
    "습관은 노력에서 시작된다.",
    "습관은 인내를 만든다.",
    "습관은 습관에서 비롯된다.",
    "습관은 매일 반복해야 한다.",
    "습관은 두려움을 이긴다.",
    "습관은 삶의 무기다.",
    "습관은 성공의 열쇠다.",
    "습관은 실력을 만든다.",
    "습관은 성장을 이끈다.",
    "습관은 나를 단단하게 만든다.",
    "습관은 더 나은 내일을 만든다.",
    "습관은 절대 배신하지 않는다.",
    "습관은 모든 것의 시작이다.",
    "습관은 실패를 극복하게 한다.",
    "습관은 끊임없이 반복된다.",
    "습관은 매일 쌓아야 한다.",
    "습관은 행동으로 증명된다.",
    "습관은 나를 믿는 것이다.",
    "습관은 스스로를 키운다.",
    "습관은 나를 바꾼다.",
    "습관은 오늘부터 가능하다.",
    "습관은 지금 시작된다.",
    "독서은 삶을 바꾼다.",
    "독서은 미래를 바꾼다.",
    "독서은 희망이 된다.",
    "독서은 노력에서 시작된다.",
    "독서은 인내를 만든다.",
    "독서은 습관에서 비롯된다.",
    "독서은 매일 반복해야 한다.",
    "독서은 두려움을 이긴다.",
    "독서은 삶의 무기다.",
    "독서은 성공의 열쇠다.",
    "독서은 실력을 만든다.",
    "독서은 성장을 이끈다.",
    "독서은 나를 단단하게 만든다.",
    "독서은 더 나은 내일을 만든다.",
    "독서은 절대 배신하지 않는다.",
    "독서은 모든 것의 시작이다.",
    "독서은 실패를 극복하게 한다.",
    "독서은 끊임없이 반복된다.",
    "독서은 매일 쌓아야 한다.",
    "독서은 행동으로 증명된다.",
    "독서은 나를 믿는 것이다.",
    "독서은 스스로를 키운다.",
    "독서은 나를 바꾼다.",
    "독서은 오늘부터 가능하다.",
    "독서은 지금 시작된다.",
    "질문은 삶을 바꾼다.",
    "질문은 미래를 바꾼다.",
    "질문은 희망이 된다.",
    "질문은 노력에서 시작된다.",
    "질문은 인내를 만든다.",
    "질문은 습관에서 비롯된다.",
    "질문은 매일 반복해야 한다.",
    "질문은 두려움을 이긴다.",
    "질문은 삶의 무기다.",
    "질문은 성공의 열쇠다.",
    "질문은 실력을 만든다.",
    "질문은 성장을 이끈다.",
    "질문은 나를 단단하게 만든다.",
    "질문은 더 나은 내일을 만든다.",
    "질문은 절대 배신하지 않는다.",
    "질문은 모든 것의 시작이다.",
    "질문은 실패를 극복하게 한다.",
    "질문은 끊임없이 반복된다.",
    "질문은 매일 쌓아야 한다.",
    "질문은 행동으로 증명된다.",
    "질문은 나를 믿는 것이다.",
    "질문은 스스로를 키운다.",
    "질문은 나를 바꾼다.",
    "질문은 오늘부터 가능하다.",
    "질문은 지금 시작된다.",
    "실패은 삶을 바꾼다.",
    "실패은 미래를 바꾼다.",
    "실패은 희망이 된다.",
    "실패은 노력에서 시작된다.",
    "실패은 인내를 만든다.",
    "실패은 습관에서 비롯된다.",
    "실패은 매일 반복해야 한다.",
    "실패은 두려움을 이긴다.",
    "실패은 삶의 무기다.",
    "실패은 성공의 열쇠다.",
    "실패은 실력을 만든다.",
    "실패은 성장을 이끈다.",
    "실패은 나를 단단하게 만든다.",
    "실패은 더 나은 내일을 만든다.",
    "실패은 절대 배신하지 않는다.",
    "실패은 모든 것의 시작이다.",
    "실패은 실패를 극복하게 한다.",
    "실패은 끊임없이 반복된다.",
    "실패은 매일 쌓아야 한다.",
    "실패은 행동으로 증명된다.",
    "실패은 나를 믿는 것이다.",
    "실패은 스스로를 키운다.",
    "실패은 나를 바꾼다.",
    "실패은 오늘부터 가능하다.",
    "실패은 지금 시작된다.",
    "도전은 삶을 바꾼다.",
    "도전은 미래를 바꾼다.",
    "도전은 희망이 된다.",
    "도전은 노력에서 시작된다.",
    "도전은 인내를 만든다.",
    "도전은 습관에서 비롯된다.",
    "도전은 매일 반복해야 한다.",
    "도전은 두려움을 이긴다.",
    "도전은 삶의 무기다.",
    "도전은 성공의 열쇠다.",
    "도전은 실력을 만든다.",
    "도전은 성장을 이끈다.",
    "도전은 나를 단단하게 만든다.",
    "도전은 더 나은 내일을 만든다.",
    "도전은 절대 배신하지 않는다.",
    "도전은 모든 것의 시작이다.",
    "도전은 실패를 극복하게 한다.",
    "도전은 끊임없이 반복된다.",
    "도전은 매일 쌓아야 한다.",
    "도전은 행동으로 증명된다.",
    "도전은 나를 믿는 것이다.",
    "도전은 스스로를 키운다.",
    "도전은 나를 바꾼다.",
    "도전은 오늘부터 가능하다.",
    "도전은 지금 시작된다.",
    "기회은 삶을 바꾼다.",
    "기회은 미래를 바꾼다.",
    "기회은 희망이 된다.",
    "기회은 노력에서 시작된다.",
    "기회은 인내를 만든다.",
    "기회은 습관에서 비롯된다.",
    "기회은 매일 반복해야 한다.",
    "기회은 두려움을 이긴다.",
    "기회은 삶의 무기다.",
    "기회은 성공의 열쇠다.",
    "기회은 실력을 만든다.",
    "기회은 성장을 이끈다.",
    "기회은 나를 단단하게 만든다.",
    "기회은 더 나은 내일을 만든다.",
    "기회은 절대 배신하지 않는다.",
    "기회은 모든 것의 시작이다.",
    "기회은 실패를 극복하게 한다.",
    "기회은 끊임없이 반복된다.",
    "기회은 매일 쌓아야 한다.",
    "기회은 행동으로 증명된다.",
    "기회은 나를 믿는 것이다.",
    "기회은 스스로를 키운다.",
    "기회은 나를 바꾼다.",
    "기회은 오늘부터 가능하다.",
    "기회은 지금 시작된다.",
    "성실함은 삶을 바꾼다.",
    "성실함은 미래를 바꾼다.",
    "성실함은 희망이 된다.",
    "성실함은 노력에서 시작된다.",
    "성실함은 인내를 만든다.",
    "성실함은 습관에서 비롯된다.",
    "성실함은 매일 반복해야 한다.",
    "성실함은 두려움을 이긴다.",
    "성실함은 삶의 무기다.",
    "성실함은 성공의 열쇠다.",
    "성실함은 실력을 만든다.",
    "성실함은 성장을 이끈다.",
    "성실함은 나를 단단하게 만든다.",
    "성실함은 더 나은 내일을 만든다.",
    "성실함은 절대 배신하지 않는다.",
    "성실함은 모든 것의 시작이다.",
    "성실함은 실패를 극복하게 한다.",
    "성실함은 끊임없이 반복된다.",
    "성실함은 매일 쌓아야 한다.",
    "성실함은 행동으로 증명된다.",
    "성실함은 나를 믿는 것이다.",
    "성실함은 스스로를 키운다.",
    "성실함은 나를 바꾼다.",
    "성실함은 오늘부터 가능하다.",
    "성실함은 지금 시작된다.",
    "끈기은 삶을 바꾼다.",
    "끈기은 미래를 바꾼다.",
    "끈기은 희망이 된다.",
    "끈기은 노력에서 시작된다.",
    "끈기은 인내를 만든다.",
    "끈기은 습관에서 비롯된다.",
    "끈기은 매일 반복해야 한다.",
    "끈기은 두려움을 이긴다.",
    "끈기은 삶의 무기다.",
    "끈기은 성공의 열쇠다.",
    "끈기은 실력을 만든다.",
    "끈기은 성장을 이끈다.",
    "끈기은 나를 단단하게 만든다.",
    "끈기은 더 나은 내일을 만든다.",
    "끈기은 절대 배신하지 않는다.",
    "끈기은 모든 것의 시작이다.",
    "끈기은 실패를 극복하게 한다.",
    "끈기은 끊임없이 반복된다.",
    "끈기은 매일 쌓아야 한다.",
    "끈기은 행동으로 증명된다.",
    "끈기은 나를 믿는 것이다.",
    "끈기은 스스로를 키운다.",
    "끈기은 나를 바꾼다.",
    "끈기은 오늘부터 가능하다.",
    "끈기은 지금 시작된다.",
    "집중력은 삶을 바꾼다.",
    "집중력은 미래를 바꾼다.",
    "집중력은 희망이 된다.",
    "집중력은 노력에서 시작된다.",
    "집중력은 인내를 만든다.",
    "집중력은 습관에서 비롯된다.",
    "집중력은 매일 반복해야 한다.",
    "집중력은 두려움을 이긴다.",
    "집중력은 삶의 무기다.",
    "집중력은 성공의 열쇠다.",
    "집중력은 실력을 만든다.",
    "집중력은 성장을 이끈다.",
    "집중력은 나를 단단하게 만든다.",
    "집중력은 더 나은 내일을 만든다.",
    "집중력은 절대 배신하지 않는다.",
    "집중력은 모든 것의 시작이다.",
    "집중력은 실패를 극복하게 한다.",
    "집중력은 끊임없이 반복된다.",
    "집중력은 매일 쌓아야 한다.",
    "집중력은 행동으로 증명된다.",
    "집중력은 나를 믿는 것이다.",
    "집중력은 스스로를 키운다.",
    "집중력은 나를 바꾼다.",
    "집중력은 오늘부터 가능하다.",
    "집중력은 지금 시작된다.",
    "호기심은 삶을 바꾼다.",
    "호기심은 미래를 바꾼다.",
    "호기심은 희망이 된다.",
    "호기심은 노력에서 시작된다.",
    "호기심은 인내를 만든다.",
    "호기심은 습관에서 비롯된다.",
    "호기심은 매일 반복해야 한다.",
    "호기심은 두려움을 이긴다.",
    "호기심은 삶의 무기다.",
    "호기심은 성공의 열쇠다.",
    "호기심은 실력을 만든다.",
    "호기심은 성장을 이끈다.",
    "호기심은 나를 단단하게 만든다.",
    "호기심은 더 나은 내일을 만든다.",
    "호기심은 절대 배신하지 않는다.",
    "호기심은 모든 것의 시작이다.",
    "호기심은 실패를 극복하게 한다.",
    "호기심은 끊임없이 반복된다.",
    "호기심은 매일 쌓아야 한다.",
    "호기심은 행동으로 증명된다.",
    "호기심은 나를 믿는 것이다.",
    "호기심은 스스로를 키운다.",
    "호기심은 나를 바꾼다.",
    "호기심은 오늘부터 가능하다.",
    "호기심은 지금 시작된다.",
]
CONVERSATION_EXPRESSIONS = [
    "안녕하세요! 오늘 하루는 어땠나요?",
    "오늘은 어떤 재미있는 일이 있었나요?",
    "최근에 읽은 책이나 본 영화가 있나요?",
    "요즘 가장 관심 있는 주제는 무엇인가요?",
    "친구들과의 대화에서 가장 기억에 남는 순간은 언제였나요?",
    "새로운 취미나 관심사를 시작해보고 싶은 게 있나요?",
    "최근에 배운 새로운 사실이나 기술이 있나요?",
    "가장 좋아하는 음식이나 요리는 무엇인가요?",
    "여행하고 싶은 장소가 있다면 어디인가요?",
    "가장 좋아하는 계절과 그 이유는 무엇인가요?",
]

class HomeView(APIView):
    permission_classes = [IsAuthenticated]

    @swagger_auto_schema(
        operation_summary="홈 화면 정보 조회",
        operation_description="""
        로그인한 부모 유저의 자녀들에 대해 홈 화면에서 보여줄 정보를 반환합니다.
        자녀별로 다음 데이터를 포함합니다:
        - 이름, 나이, 스트릭
        - 이번 달 상위 3개 도장의 스티커 타입/라벨/개수
        - 랜덤 명언, 랜덤 회화 표현
        """,
        responses={
            200: openapi.Response(
                description="자녀별 홈 화면 정보 리스트",
                examples={
                    "application/json": [
                        {
                            "name": "지민",
                            "age": 9,
                            "streak": 3,
                            "top_3_stickers": [
                                {"sticker_type": 3, "label": "참 잘했어요", "count": 5},
                                {"sticker_type": 5, "label": "정말 최고예요", "count": 3}
                            ],
                            "quote": "공부는 끝이 없는 여행이다.",
                            "conversation": "How are you today?"
                        }
                    ]
                }
            ),
            204: "등록된 자녀가 없습니다.",
            401: "인증 필요"
        }
    )
    def get(self, request):
        ret = []

        children = ChildUser.objects.filter(parent=request.user)
        if not children.exists():
            return Response({"message": "등록된 자녀가 없습니다."}, status=status.HTTP_204_NO_CONTENT)

        now = datetime.now()
        label_map = dict(RewardCalendar.STICKER_CHOICES)

        for child in children:
            child_data = {
                "name": child.name,
                "age": child.age,
                "streak": child.streak
            }

            reward_calendar = RewardCalendar.objects.filter(
                child=child,
                date__year=now.year,
                date__month=now.month,
            )

            counts = reward_calendar.values("sticker_type").annotate(
                count=Count("sticker_type")
            ).order_by("-count")[:3]

            top_3 = [
                {
                    "sticker_type": item["sticker_type"],
                    "label": label_map.get(item["sticker_type"], "알 수 없음"),
                    "count": item["count"]
                }
                for item in counts
            ]
            child_data["top_3_stickers"] = top_3

            child_data['quote'] = KOREAN_LEARNING_QUOTES[randint(0, len(KOREAN_LEARNING_QUOTES) - 1)]
            child_data['conversation'] = CONVERSATION_EXPRESSIONS[randint(0, len(CONVERSATION_EXPRESSIONS) - 1)]

            ret.append(child_data)

        return Response(ret, status=status.HTTP_200_OK)

